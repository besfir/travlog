(function(L){const I="transitionend";function E(t,e){for(const s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);return t}function N(t){let e=[];const s=t.length,i=t[0].length;for(let h=0;h<s;h++)e=e.concat(t[h]);e=b(e);const o=[];let a=0;for(let h=0;h<s;h++){const f=[];for(let p=0;p<i;p++)f.push(e[a]),a++;o.push(f)}return o}function b(t){let e=t.length,s,i;for(;e;)i=Math.floor(Math.random()*e--),s=t[e],t[e]=t[i],t[i]=s;return t}function r(t,e){if(this.el=t,this.inner=this.el.querySelector("div"),this.allItems=[].slice.call(this.inner.children),this.allItemsCount=this.allItems.length,!this.allItemsCount)return;this.items=[].slice.call(this.inner.querySelectorAll("figure:not([data-dummy])")),this.itemsCount=this.items.length,this.options=E({},this.options),E(this.options,e),this.current=this.options.start,this._init();const s=this;return{showPhoto:function(i){s._showPhoto.call(s,i)},open:function(){s._open.call(s,!0)},navigate:function(i){s._navigate.call(s,i)}}}r.prototype.options={start:0,showNavigation:!0,afterInit:null,afterShowPhoto:null,afterNavigate:null},r.prototype._init=function(){this.currentItem=this.items[this.current],this.options.showNavigation&&this._addNavigation(),this._getSizes(),this._initEvents(),this.options.afterInit&&this.options.afterInit(this)},r.prototype._addNavigation=function(){this.nav=document.createElement("nav");let t="";for(let e=0;e<this.itemsCount;++e)t+="<span></span>";this.nav.innerHTML=t,this.el.appendChild(this.nav),this.navDots=[].slice.call(this.nav.children)},r.prototype._open=function(t){const e=this,s=this.el,i=function(){s.classList.add("photostack-transition")};t?(s.removeEventListener("click",function(){open()}),s.classList.remove("photostack-start"),i()):(e.openDefault=!0,setTimeout(i,25)),e.started=!0,e._showPhoto(e.current)},r.prototype._initEvents=function(){const t=this,e=this.el.classList.contains("photostack-start");this.options.clickToFlip=="true"&&this.items.forEach(function(s,i){s.addEventListener("click",function(o){o.preventDefault(),i===t.current&&t._rotateItem()})}),e?(this._shuffle(),this.el.addEventListener("click",function(){t._open(e)})):this._open(e),this.options.showNavigation&&this.navDots.forEach(function(s,i){s.addEventListener("click",function(){if(i===t.current)t._rotateItem();else{const o=function(){t._showPhoto(i)};t.flipped?t._rotateItem(o):o()}})}),L.addEventListener("resize",function(){t._resizeHandler()})},r.prototype._resizeHandler=function(){const t=this;function e(){t._resize(),t._resizeTimeout=null}this._resizeTimeout&&clearTimeout(this._resizeTimeout),this._resizeTimeout=setTimeout(e,100)},r.prototype._resize=function(){const t=this,e=function(){t._shuffle(!0)};this._getSizes(),this.started&&this.flipped?this._rotateItem(e):e()},r.prototype._showPhoto=function(t){if(this.isShuffling)return!1;this.isShuffling=!0,this.currentItem.classList.contains("photostack-flip")&&(this._removeItemPerspective(),this.options.showNavigation&&this.navDots[this.current].classList.remove("flippable")),this.options.showNavigation&&this.navDots[this.current].classList.remove("current"),this.currentItem.classList.remove("photostack-current"),this.current=t,this.currentItem=this.items[this.current],this.options.showNavigation&&this.navDots[this.current].classList.add("current"),this.options.showNavigation&&this.currentItem.querySelector(".photostack-back")&&this.navDots[t].classList.add("flippable"),this._shuffle(),this.options.afterShowPhoto&&this.options.afterShowPhoto(this)},r.prototype._shuffle=function(t){let e=t?1:this.currentItem.getAttribute("data-shuffle-iteration")||1;(e<=0||!this.started||this.openDefault)&&(e=1),this.openDefault&&(this.currentItem.classList.add("photostack-flip"),this.openDefault=!1,this.isShuffling=!1);const s=.5,i=Math.ceil(this.sizes.inner.width/(this.sizes.item.width*s)),o=Math.ceil(this.sizes.inner.height/(this.sizes.item.height*s)),a=i*this.sizes.item.width*s+this.sizes.item.width/2-this.sizes.inner.width,h=o*this.sizes.item.height*s+this.sizes.item.height/2-this.sizes.inner.height,f=a/2,p=h/2,d=35,v=-35,n=this,T=function(){--e;let x=[];for(let c=0;c<o;++c){const S=x[c]=[];for(let u=0;u<i;++u){const l=u*(n.sizes.item.width*s)-f,g=c*(n.sizes.item.height*s)-p;let z=0,w=0;if(n.started&&e===0){const k=n._isOverlapping({x:l,y:g});if(k.overlapping)switch(z=k.noOverlap.x,w=k.noOverlap.y,m(0,2)){case 0:z=0;break;case 1:w=0;break}}S[u]={x:l+z,y:g+w}}}x=N(x);let y=0,_=0,P=0;n.allItems.forEach(function(c,S){y===i-1?(_=_===o-1?0:_+1,y=1):++y;const u=x[_][y-1],l={x:u.x,y:u.y},g=function(){++P,this.removeEventListener(I,g),P===n.allItemsCount&&(e>0?T.call():(n.currentItem.classList.add("photostack-flip"),n.isShuffling=!1,typeof n.options.callback=="function"&&n.options.callback(n.currentItem)))};n.items.indexOf(c)===n.current&&n.started&&e===0?(n.currentItem.style.WebkitTransform="translate("+n.centerItem.x+"px,"+n.centerItem.y+"px) rotate(0deg)",n.currentItem.style.msTransform="translate("+n.centerItem.x+"px,"+n.centerItem.y+"px) rotate(0deg)",n.currentItem.style.transform="translate("+n.centerItem.x+"px,"+n.centerItem.y+"px) rotate(0deg)",n.currentItem.querySelector(".photostack-back")&&n._addItemPerspective(),n.currentItem.classList.add("photostack-current")):(c.style.WebkitTransform="translate("+l.x+"px,"+l.y+"px) rotate("+m(v,d)+"deg)",c.style.msTransform="translate("+l.x+"px,"+l.y+"px) rotate("+m(v,d)+"deg)",c.style.transform="translate("+l.x+"px,"+l.y+"px) rotate("+m(v,d)+"deg)"),n.started&&c.addEventListener(I,g)})};T.call()},r.prototype._navigate=function(t){const e=this.current,i=this.itemsCount-1;let o=0;t=="next"?o=e<i?e+1:0:t=="prev"&&(o=e>0?e-1:i),this._showPhoto(o),this.options.afterNavigate&&this.options.afterNavigate(this)},r.prototype._getSizes=function(){this.sizes={inner:{width:this.inner.offsetWidth,height:this.inner.offsetHeight},item:{width:this.currentItem.offsetWidth,height:this.currentItem.offsetHeight}},this.centerItem={x:this.sizes.inner.width/2-this.sizes.item.width/2,y:this.sizes.inner.height/2-this.sizes.item.height/2}},r.prototype._isOverlapping=function(t){const e=this.sizes.item.width+this.sizes.item.width/3,s=this.sizes.item.height+this.sizes.item.height/3,i={x:this.sizes.inner.width/2-e/2,y:this.sizes.inner.height/2-s/2},o=this.sizes.item.width,a=this.sizes.item.height;if(!(t.x+o<i.x||t.x>i.x+e||t.y+a<i.y||t.y>i.y+s)){const h=Math.random()<.5,f=m(0,o/4),p=m(0,a/4),d=h?(t.x-i.x+o)*-1-f:i.x+e-(t.x+o)+o+f,v=h?(t.y-i.y+a)*-1-p:i.y+s-(t.y+a)+a+p;return{overlapping:!0,noOverlap:{x:d,y:v}}}return{overlapping:!1}},r.prototype._addItemPerspective=function(){this.el.classList.add("photostack-perspective")},r.prototype._removeItemPerspective=function(){this.el.classList.remove("photostack-perspective"),this.currentItem.classList.remove("photostack-flip")},r.prototype._rotateItem=function(t){if(this.el.classList.contains("photostack-perspective")&&!this.isRotating&&!this.isShuffling){this.isRotating=!0;const e=this,s=function(){this.removeEventListener(I,s),e.isRotating=!1,typeof t=="function"&&t()};this.flipped?(this.options.showNavigation&&this.navDots[this.current].classList.remove("flip"),this.currentItem.style.WebkitTransform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) rotateY(0deg)",this.currentItem.style.transform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) rotateY(0deg)"):(this.options.showNavigation&&this.navDots[this.current].classList.add("flip"),this.currentItem.style.WebkitTransform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) translate("+this.sizes.item.width+"px) rotateY(-179.9deg)",this.currentItem.style.transform="translate("+this.centerItem.x+"px,"+this.centerItem.y+"px) translate("+this.sizes.item.width+"px) rotateY(-179.9deg)"),this.flipped=!this.flipped,this.currentItem.addEventListener(I,s)}};function m(t,e){return Math.floor(Math.random()*(e-t+1))+t}L.Photostack=r})(window);
